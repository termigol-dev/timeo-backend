generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ======================
/// COMPANY
/// ======================
model Company {
  id             String       @id @default(uuid())
  nif            String       @unique
  legalName      String
  commercialName String
  address        String
  plan           String
  active         Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  branches    Branch[]
  memberships Membership[]
  records     Record[]
  incidents   Incident[]
}

/// ======================
/// BRANCH
/// ======================
model Branch {
  id           String  @id @default(uuid())
  name         String
  address      String
  active       Boolean @default(true)
  tabletToken  String? @unique
  tabletActive Boolean @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  memberships Membership[]
  records     Record[]
  schedules   Schedule[]
  incidents   Incident[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, name])
}

/// ======================
/// USER (GLOBAL)
/// ======================
model User {
  id            String       @id @default(uuid())
  name          String
  firstSurname  String
  secondSurname String?
  dni           String
  email         String       @unique
  password      String
  photoUrl      String?
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  memberships Membership[]
  records     Record[]
  schedules   Schedule[]
  incidents   Incident[]
}

/// ======================
/// MEMBERSHIP (CLAVE)
/// ======================
model Membership {
  id        String   @id @default(uuid())
  userId    String
  companyId String
  branchId  String?
  role      Role
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  branch    Branch?  @relation(fields: [branchId], references: [id])
  company   Company  @relation(fields: [companyId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  records   Record[]
  incidents Incident[]

  @@unique([userId, companyId])
}

/// ======================
/// RECORDS (IN / OUT)
/// ======================
model Record {
  id           String     @id @default(uuid())
  type         RecordType
  userId       String
  membershipId String
  companyId    String
  branchId     String
  createdAt    DateTime   @default(now())

  branch       Branch     @relation(fields: [branchId], references: [id])
  company      Company    @relation(fields: [companyId], references: [id])
  membership   Membership @relation(fields: [membershipId], references: [id])
  user         User       @relation(fields: [userId], references: [id])

  incidents    Incident[]
}

/// ======================
/// INCIDENTS (INCIDENCIAS / NOTAS)
/// ======================
model Incident {
  id            String       @id @default(uuid())

  type          IncidentType
  createdBy     IncidentBy
  response      IncidentResponse @default(PENDING)

  userId        String
  membershipId  String
  companyId     String
  branchId      String
  recordId      String?

  admitted      Boolean      @default(false)

  expectedAt    DateTime?
  occurredAt    DateTime     @default(now())
  note          String?

  createdAt     DateTime     @default(now())

  user        User        @relation(fields: [userId], references: [id])
  membership  Membership  @relation(fields: [membershipId], references: [id])
  company     Company     @relation(fields: [companyId], references: [id])
  branch      Branch      @relation(fields: [branchId], references: [id])
  record      Record?     @relation(fields: [recordId], references: [id])

  @@index([userId])
  @@index([membershipId])
  @@index([companyId])
  @@index([branchId])
  @@index([recordId])
}

/// ======================
/// SCHEDULE (HORARIO)
/// ======================
model Schedule {
  id        String   @id @default(uuid())
  userId    String
  branchId  String

  validFrom DateTime
  validTo   DateTime?

  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  branch Branch @relation(fields: [branchId], references: [id])

  shifts Shift[]

  @@index([userId])
  @@index([branchId])
}

/// ======================
/// SHIFT (TURNO)
/// ======================
model Shift {
  id         String @id @default(uuid())
  scheduleId String

  weekday    Int    // 1 = lunes ... 7 = domingo
  startTime  String // "09:00"
  endTime    String // "13:00"

  schedule Schedule @relation(fields: [scheduleId], references: [id])

  @@index([scheduleId])
}

/// ======================
/// ENUMS
/// ======================
enum Role {
  SUPERADMIN
  ADMIN_EMPRESA
  ADMIN_SUCURSAL
  EMPLEADO
}

enum RecordType {
  IN
  OUT
}

enum IncidentType {
  IN_EARLY
  IN_LATE
  OUT_LATE
  FORGOT_IN
  FORGOT_OUT
  WRONG_IN
  ADMIN_NOTE
}

enum IncidentBy {
  SYSTEM
  EMPLOYEE
  ADMIN
}

enum IncidentResponse {
  PENDING
  ADMITTED
  DENIED
}